{% extends 'base.html' %}
{% block title %}{{ student_name }}ã®ToDo{% endblock %}
{% block content %}
    <h2>{{ student_name }}ã®ToDoï¼ˆ{{ date }}ï¼‰</h2>
    <div style="display: flex; align-items: center; gap: 1em; margin: 1em 0; flex-wrap: wrap;">
        <a href="{{ url_for('main.student_view', student_name=student_name, date=prev_date) }}">ï¼œ å‰ã®æ—¥</a>
        <form method="GET" style="margin: 0;">
            <input type="date" name="date" value="{{ date }}">
            <input type="submit" value="æ—¥ä»˜ã§è¡¨ç¤º">
        </form>
        <a href="{{ url_for('main.student_view', student_name=student_name, date=next_date) }}">æ¬¡ã®æ—¥ ï¼</a>
    </div>
    <a href="{{ url_for('main.student_chart', student_name=student_name) }}" target="_blank">ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’è¦‹ã‚‹</a>
    <hr style="margin: 2em 0;">
    <h3>æ–°ã—ã„ToDoã‚’è¿½åŠ ï¼ˆç›®æ¨™è¨­å®šï¼‰</h3>
    <form id="add-todo-form">
        <input type="hidden" name="date" value="{{ date }}">
        <label for="subject">æ•™ç§‘ï¼š</label>
        <select name="subject" id="subject" required>
            <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å›½èª">å›½èª</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="ç†ç§‘">ç†ç§‘</option>
            <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
            <option value="è‹±èª">è‹±èª</option>
        </select><br>
        <label for="material">æ•™æåï¼ˆä»»æ„ï¼‰ï¼š</label>
        <input type="text" id="material" name="material" pattern="[^\x20-\x7E]*" title="æ—¥æœ¬èªã§å…¥åŠ›ã—ã¦ãã ã•ã„"><br>
        <label for="start_page">é–‹å§‹ãƒšãƒ¼ã‚¸ï¼š</label>
        <input type="number" id="start_page" name="start_page" min="1" max="300">
        <label for="end_page">çµ‚äº†ãƒšãƒ¼ã‚¸ï¼š</label>
        <input type="number" id="end_page" name="end_page" min="1" max="300"><br>
        <label>ç›®æ¨™æ™‚é–“ï¼š</label>
        <input type="number" name="target_hour" min="0" value="0" style="width: 50px;"> æ™‚é–“
        <input type="number" name="target_min" min="0" max="59" value="0" style="width: 50px;"> åˆ†<br>
        <br>
        <input type="submit" value="ToDoã‚’è¿½åŠ ">
    </form>
    <hr style="margin: 2em 0;">
    <h3>ToDoãƒªã‚¹ãƒˆ</h3>
    <table id="todo-table">
        <thead>
            <tr>
                <th>æ•™ç§‘</th><th>æ•™æ</th><th>ãƒšãƒ¼ã‚¸</th><th>ç›®æ¨™</th><th>å®Ÿç¸¾ & å®Œäº†å ±å‘Š</th><th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="todo-list-body">
            {% for todo in todos %}
            <tr data-todo-id="{{ todo.id }}">
                <td>{{ todo.subject }}</td>
                <td>{{ todo.material }}</td>
                <td>{{ todo.start_page }} - {{ todo.end_page }}</td>
                <td>{{ todo.target_hour }}h {{ todo.target_min }}m</td>
                <td class="status-cell">
                    {% if todo.completed %}
                        âœ” {{ todo.actual_hour }}h {{ todo.actual_min }}m
                    {% else %}
                        <form class="update-todo-form" data-id="{{ todo.id }}">
                            <input type="number" name="actual_hour" min="0" value="0" style="width: 40px;"> æ™‚é–“
                            <input type="number" name="actual_min" min="0" max="59" value="0" style="width: 40px;"> åˆ†
                            <input type="submit" value="å®Œäº†" style="width: auto; padding: 5px 10px; font-size: 0.9em;">
                        </form>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('main.edit_todo', todo_id=todo.id) }}">ç·¨é›†</a>
                    <a href="#" class="delete-link" data-id="{{ todo.id }}">å‰Šé™¤</a>
                </td>
            </tr>
            {% else %}
            <tr id="no-todos-row">
                <td colspan="6" style="text-align: center;">ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
<script>
// ToDoè¿½åŠ ã®éåŒæœŸå‡¦ç†
document.getElementById('add-todo-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    fetch('/api/add_todo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newRow = createTodoRow(data.todo);
            document.getElementById('todo-list-body').appendChild(newRow);
            document.getElementById('no-todos-row')?.remove(); // ã€ŒToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€ã®è¡Œã‚’å‰Šé™¤
            this.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
    });
});

// ToDoå®Œäº†ã®éåŒæœŸå‡¦ç†
document.getElementById('todo-list-body').addEventListener('submit', function(event) {
    if (event.target.classList.contains('update-todo-form')) {
        event.preventDefault();
        const form = event.target;
        const todoId = form.dataset.id;
        const formData = new FormData(form);
        const statusCell = form.parentElement;

        fetch(`/api/update_todo/${todoId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusCell.innerHTML = `âœ” ${data.actual_hour}h ${data.actual_min}m`;
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
            }
        });
    }
});

// å‰Šé™¤ãƒªãƒ³ã‚¯ã®éåŒæœŸå‡¦ç†ï¼ˆæ—¢å­˜ï¼‰
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('delete-link')) {
        event.preventDefault();
        // ... æ—¢å­˜ã®å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯ ...
    }
});

// æ–°ã—ã„ToDoã®è¡Œã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function createTodoRow(todo) {
    const tr = document.createElement('tr');
    tr.dataset.todoId = todo.id;
    tr.innerHTML = `
        <td>${todo.subject}</td>
        <td>${todo.material}</td>
        <td>${todo.start_page} - ${todo.end_page}</td>
        <td>${todo.target_hour}h ${todo.target_min}m</td>
        <td class="status-cell">
            <form class="update-todo-form" data-id="${todo.id}">
                <input type="number" name="actual_hour" min="0" value="0" style="width: 40px;"> æ™‚é–“
                <input type="number" name="actual_min" min="0" max="59" value="0" style="width: 40px;"> åˆ†
                <input type="submit" value="å®Œäº†" style="width: auto; padding: 5px 10px; font-size: 0.9em;">
            </form>
        </td>
        <td>
            <a href="/edit_todo/${todo.id}">ç·¨é›†</a>
            <a href="#" class="delete-link" data-id="${todo.id}">å‰Šé™¤</a>
        </td>
    `;
    return tr;
}
</script>
{% endblock %}