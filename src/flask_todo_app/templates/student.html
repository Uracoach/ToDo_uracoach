{% extends 'base.html' %}
{% block title %}{{ student_name }}ã®ToDo{% endblock %}
{% block content %}
    <h2>{{ student_name }}ã®ToDoï¼ˆ{{ date }}ï¼‰</h2>
    <div style="display: flex; align-items: center; gap: 1em; margin: 1em 0; flex-wrap: wrap;">
        <a href="{{ url_for('main.student_view', student_name=student_name, date=prev_date) }}">ï¼œ å‰ã®æ—¥</a>
        <form method="GET" style="margin: 0;">
            <input type="date" name="date" value="{{ date }}">
            <input type="submit" value="æ—¥ä»˜ã§è¡¨ç¤º">
        </form>
        <a href="{{ url_for('main.student_view', student_name=student_name, date=next_date) }}">æ¬¡ã®æ—¥ ï¼</a>
    </div>
    <a href="{{ url_for('main.student_chart', student_name=student_name) }}" target="_blank">ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’è¦‹ã‚‹</a>

    <hr style="margin: 2em 0;">

    <h3>ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>
    <div style="background: #fff; padding: 1em; border-radius: 8px; margin-bottom: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    {% if missions %}
        {% for mission in missions %}
            <div>
                <p><strong>{{ mission.description }}</strong></p>
                {% if mission.subject_target %}
                    {% set progress = weekly_progress[mission.subject_target] | default(0) %}
                    {% set goal = mission.minutes_target %}
                    <p>{{ mission.subject_target }}: {{ progress }} / {{ goal }} åˆ†</p>
                    <progress value="{{ progress }}" max="{{ goal }}" style="width: 100%;"></progress>
                {% endif %}
            </div>
            {% if not loop.last %}<hr style="border-style: dashed; border-color: #ccc;">{% endif %}
        {% endfor %}
    {% else %}
        <p>ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
    </div>
    <h3>æ–°ã—ã„ToDoã‚’è¿½åŠ ï¼ˆç›®æ¨™è¨­å®šï¼‰</h3>
    <form id="add-todo-form">
        <input type="hidden" name="date" value="{{ date }}">
        <label for="subject">æ•™ç§‘ï¼š</label>
        <select name="subject" id="subject" required>
            <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å›½èª">å›½èª</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="ç†ç§‘">ç†ç§‘</option>
            <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
            <option value="è‹±èª">è‹±èª</option>
        </select><br>
        <label for="material">æ•™æåï¼ˆä»»æ„ï¼‰ï¼š</label>
        <input type="text" id="material" name="material" pattern="[^\x20-\x7E]*" title="æ—¥æœ¬èªã§å…¥åŠ›ã—ã¦ãã ã•ã„"><br>
        <label for="start_page">é–‹å§‹ãƒšãƒ¼ã‚¸ï¼š</label>
        <input type="number" id="start_page" name="start_page" min="1" max="300">
        <label for="end_page">çµ‚äº†ãƒšãƒ¼ã‚¸ï¼š</label>
        <input type="number" id="end_page" name="end_page" min="1" max="300"><br>
        <label>ç›®æ¨™æ™‚é–“ï¼š</label>
        <input type="number" name="target_hour" min="0" value="0" style="width: 50px;"> æ™‚é–“
        <input type="number" name="target_min" min="0" max="59" value="0" style="width: 50px;"> åˆ†<br>
        <br>
        <input type="submit" value="ToDoã‚’è¿½åŠ ">
    </form>
    <hr style="margin: 2em 0;">
    <h3>ToDoãƒªã‚¹ãƒˆ</h3>
    <table id="todo-table">
        <thead>
            <tr>
                <th>æ•™ç§‘</th><th>æ•™æ</th><th>ãƒšãƒ¼ã‚¸</th><th>ç›®æ¨™</th><th>å®Ÿç¸¾ & å®Œäº†å ±å‘Š</th><th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="todo-list-body">
            {% for todo in todos %}
            <tr data-todo-id="{{ todo.id }}">
                <td>{{ todo.subject }}</td>
                <td>{{ todo.material }}</td>
                <td>{{ todo.start_page }} - {{ todo.end_page }}</td>
                <td>{{ todo.target_hour }}h {{ todo.target_min }}m</td>
                <td class="status-cell">
                    {% if todo.completed %}
                        âœ” {{ todo.actual_hour }}h {{ todo.actual_min }}m
                    {% else %}
                        <form class="update-todo-form" data-id="{{ todo.id }}">
                            <input type="number" name="actual_hour" min="0" value="0" style="width: 40px;"> æ™‚é–“
                            <input type="number" name="actual_min" min="0" max="59" value="0" style="width: 40px;"> åˆ†
                            <input type="submit" value="å®Œäº†" style="width: auto; padding: 5px 10px; font-size: 0.9em;">
                        </form>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('main.edit_todo', todo_id=todo.id) }}">ç·¨é›†</a>
                    <a href="#" class="delete-link" data-id="{{ todo.id }}">å‰Šé™¤</a>
                </td>
            </tr>
            {% endfor %}
            <tr id="no-todos-row" {% if todos %}style="display: none;"{% endif %}>
                <td colspan="6" style="text-align: center;">ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
            </tr>
        </tbody>
    </table>
{% endblock %}
{% block scripts %}
<script>
// ... (æ—¢å­˜ã®AJAXã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å¤‰æ›´ãªã—) ...
</script>
{% endblock %}