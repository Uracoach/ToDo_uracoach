{% extends 'base.html' %}
{% block title %}{{ student_name }}の学習集計表{% endblock %}
{% block content %}
<div class="summary-container">
    <h1 class="main-title">努力は裏切らない</h1>
    <form method="GET">
        <label for="month">表示する月を選択:</label>
        <input type="month" id="month" name="month" value="{{ month_str }}">
        <input type="submit" value="表示" style="width: auto; padding: 5px 10px;">
    </form>
    <table class="summary-table">
        <thead>
            <tr>
                <th>教科</th>
                <th>今日 ({{ date_info.today }})</th>
                <th>今週 ({{ date_info.week_start }}~{{ date_info.week_end }})</th>
                <th>今月 ({{ date_info.month }})</th>
                <th>今までの合計 ({{ date_info.total_days }}日間)</th>
            </tr>
        </thead>
        <tbody>
            {% for subject, data in summary_data.items() %}
            <tr>
                <td class="subject-col">{{ subject }}</td>
                <td>{{ data.today_total // 60 }}時間 {{ data.today_total % 60 }}分</td>
                <td>{{ data.week_total // 60 }}時間 {{ data.week_total % 60 }}分</td>
                <td>{{ data.month_total // 60 }}時間 {{ data.month_total % 60 }}分</td>
                <td>{{ data.all_time_total // 60 }}時間 {{ data.all_time_total % 60 }}分</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td class="subject-col">合計</td>
                <td>{{ total_row.today // 60 }}時間 {{ total_row.today % 60 }}分</td>
                <td>{{ total_row.week // 60 }}時間 {{ total_row.week % 60 }}分</td>
                <td>{{ total_row.month // 60 }}時間 {{ total_row.month % 60 }}分</td>
                <td>{{ total_row.all_time // 60 }}時間 {{ total_row.all_time % 60 }}分</td>
            </tr>
        </tfoot>
    </table>
    <div class="monthly-total-container">
        <h3>{{ date_info.month }}の総学習時間</h3>
        <div class="counter-value" data-total-minutes="{{ total_row.month }}">
            <span id="hours">0</span>時間 <span id="minutes">0</span>分
        </div>
    </div>
    <div class="level-container">
        <div>{{ date_info.month }}のあなたは... <span class="level-text level-text-effect" style="{{ level_style | safe }}">{{ level_text }}</span> ！！</div>
        {% if comparison_minutes > 0 %}
            <div class="comparison-text plus">
                先月より {{ comparison_minutes // 60 }}時間 {{ comparison_minutes % 60 }}分 も多く勉強しました！素晴らしい！
            </div>
        {% elif comparison_minutes < 0 %}
            <div class="comparison-text minus">
                先月より {{ (-comparison_minutes) // 60 }}時間 {{ (-comparison_minutes) % 60 }}分 少なかったようです。来月は頑張ろう！
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const counterElement = document.querySelector('.counter-value');
    if (!counterElement) return;
    const hoursSpan = document.getElementById('hours');
    const minutesSpan = document.getElementById('minutes');
    const totalMinutes = parseInt(counterElement.dataset.totalMinutes, 10);
    if (isNaN(totalMinutes)) return;

    if (totalMinutes === 0) {
        hoursSpan.textContent = 0;
        minutesSpan.textContent = 0;
        return;
    }
    
    let currentMinutes = 0;
    const duration = 1500;
    const stepTime = 20;
    const totalSteps = duration / stepTime;
    const increment = totalMinutes / totalSteps;
    const timer = setInterval(() => {
        currentMinutes += increment;
        if (currentMinutes >= totalMinutes) {
            currentMinutes = totalMinutes;
            clearInterval(timer);
        }
        const hours = Math.floor(currentMinutes / 60);
        const minutes = Math.floor(currentMinutes % 60);
        hoursSpan.textContent = hours;
        minutesSpan.textContent = minutes;
    }, stepTime);
});
</script>
{% endblock %}